@page "/users"
@rendermode InteractiveServer
<style>
    tr:hover.user-tr {
        background-color: lightgray;
    }
</style>
<h3>Users</h3>
<p>(click user to see Todos)</p>

@if (_users.Count < 1)
{
    <p><em>Fetching User Information...</em></p>
}
else
{
    @if (_userDataErrorMessage != null)
    {
        <p>Could not load user data (@_userDataErrorMessage)</p>
        <p>Please contact admin, displaying sample data</p>
    }
    @if (_userIndexOftOfRangeMessage != null)
    {
        <p>_userIndexOftOfRangeMessage</p>
    }

    <InputSelect @bind-Value="_userPageUtilities.SearchOption">
        <option value="@UserProperty.Name">Search by Name</option>
        <option value="@UserProperty.City">Search by City</option>
    </InputSelect>
    <input id="search" @bind-value="_userPageUtilities.SearchTerm" @oninput=OnSearchInput />
    <br />

    <InputSelect @bind-Value="_userPageUtilities.SortOption" @bind-Value:after=Sort>
        <option value="@UserProperty.Name">Sort by Name</option>
        <option value="@UserProperty.ID">Sort by ID</option>
    </InputSelect>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>City</th>
                <th>Street</th>
                <th>Zip Code</th>
                <th>Company</th>
                <th>Company Catchphrase</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in _filteredUsers)
            {
                <tr class="user-tr" @onclick="() => ShowToDos(user)" style="cursor: pointer;">
                    <td>@user.ID</td>
                    <td>@user.Name</td>
                    <td>@user.Email</td>
                    <td>@user.Address.City</td>
                    <td>@user.Address.Street</td>
                    <td>@user.Address.ZipCode</td>
                    <td>@user.Company.Name</td>
                    <td>@user.Company.CatchPhrase</td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" @onclick=ShowAll>Show All</button>
    <button type="button" @onclick=ShowLess>Show Less</button>
    <br />

    @if (_showToDos)
    {
        <Todos DataAccess="_dataAccess" CurrentUser="_currentUser"></Todos>
    }
}

@code {
    private IDataAccess? _dataAccess;
    private List<User> _users = new List<User>();
    private List<User> _filteredUsers = new List<User>();    
    private UsersPageUtilities _userPageUtilities = new UsersPageUtilities();

    private int _numberOfShownUsers;
    private string? _userDataErrorMessage;
    private string? _userIndexOftOfRangeMessage;
    private bool _showToDos = false;
    private User _currentUser = new User();

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(1000);
        SetUserData();
        ShowLess();
    }
    private void SetUserData()
    {
        try
        {
            _dataAccess = new JSONDataAccess();
            _users = _dataAccess.GetUsers();
            _userDataErrorMessage = null;
        }
        catch (AggregateException e)
        {
            _dataAccess = new SampleDataAccess();
            _users = _dataAccess.GetUsers();
            _userDataErrorMessage = e.Message;

        }
        catch (HttpRequestException e)
        {
            _dataAccess = new SampleDataAccess();
            _users = _dataAccess.GetUsers();
            _userDataErrorMessage = e.Message;
        }
    }
    private void ShowToDos(User user)
    {
        if (user == _currentUser)
        {
            _showToDos = (_showToDos) ? false : true;
        }
        else
        {
            _showToDos = true;
        }
        _currentUser = user;
    }
    private void ShowAll()
    {
        _numberOfShownUsers = (_users != null) ? _users.Count : 0;
        Filter();
    }
    public void ShowLess()
    {
        _numberOfShownUsers = 5;
        Filter();
    }
    public void Filter()
    {
        Search();
        Sort();
        if (_numberOfShownUsers < _filteredUsers.Count)
        {
            try
            {
                ShowNumberOfUsers();
                _userIndexOftOfRangeMessage = null;
            }
            catch (ArgumentOutOfRangeException e)
            {
                _userIndexOftOfRangeMessage = e.Message;
            }
        }
    }
    private void OnSearchInput(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            _userPageUtilities.SearchTerm = e.Value.ToString() ?? string.Empty;
        }              
        Filter();
    }
    private void Search()
    {
        _filteredUsers = _users.Search(_userPageUtilities.SearchOption, _userPageUtilities.SearchTerm);
    }
    private void Sort()
    {
        _filteredUsers = _filteredUsers.Order(_userPageUtilities.SortOption);
    }
    private void ShowNumberOfUsers() => _filteredUsers = _filteredUsers.FilterUsersByAmount(_numberOfShownUsers);
}
